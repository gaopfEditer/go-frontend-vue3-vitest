# 测试问题排查指南

## 为什么很多测试通不过？

### 问题 1: router-view-stub 找不到

**错误信息:**
```
expect(wrapper.find('router-view-stub').exists()).toBe(true)
                                     ^
❌ 找不到元素
```

**原因:**
- 当使用 `mount` 而不是 `shallowMount` 时，router-view 可能不会被自动 stub
- Vue Router 组件需要手动 stub 或者使用真实的 router

**解决方案:**

```javascript
// 方案 1: 使用 stubs 配置
wrapper = mount(App, {
  global: {
    plugins: [pinia, router, i18n, ElementPlus],
    stubs: {
      'router-view': true
    }
  }
})

// 方案 2: 使用 shallowMount（浅渲染）
wrapper = shallowMount(App, {
  global: {
    plugins: [pinia, router, i18n, ElementPlus]
  }
})
```

### 问题 2: localStorage 未定义

**错误信息:**
```
localStorage.getItem is not a function
❌ 或
Cannot read property 'getItem' of undefined
```

**原因:**
- jsdom 环境可能没有正确设置 localStorage

**解决方案:**

```javascript
// tests/setup.js
if (typeof Storage === 'undefined') {
  global.localStorage = {
    getItem: vi.fn(() => null),
    setItem: vi.fn(),
    removeItem: vi.fn(),
    clear: vi.fn(),
  }
}
```

### 问题 3: Store 未正确 Mock

**错误信息:**
```
useStore is not a function
❌ 或
Cannot read property 'initUserInfo' of undefined
```

**原因:**
- Store 模块没有被正确 Mock

**解决方案:**

```javascript
// tests/App.test.js
const mockStore = {
  initUserInfo: vi.fn()
}

vi.mock('../src/utils/stores', () => ({
  useStore: () => mockStore
}))
```

### 问题 4: 异步更新未等待

**错误信息:**
```
Expected: true
Received: false
❌ 状态未更新
```

**原因:**
- Vue 的响应式更新是异步的
- 需要等待 `$nextTick`

**解决方案:**

```javascript
it('应该更新状态', async () => {
  wrapper = mount(Component)
  
  // 执行操作
  await wrapper.vm.someMethod()
  
  // 等待更新
  await wrapper.vm.$nextTick()
  
  // 验证结果
  expect(wrapper.vm.someState).toBe(expected)
})
```

## 修复后的关键点

### ✅ 1. 使用 Stubs

```javascript
wrapper = mount(Component, {
  global: {
    stubs: {
      'router-view': true,        // Stub 路由
      'el-config-provider': true, // Stub Element Plus
      'SomeComponent': true       // Stub 其他组件
    }
  }
})
```

### ✅ 2. Mock 外部依赖

```javascript
// Mock Store
vi.mock('../src/utils/stores', () => ({
  useStore: () => ({ initUserInfo: vi.fn() })
}))

// Mock API
vi.mock('../src/utils/api', () => ({
  auth: {
    login: vi.fn(),
    register: vi.fn()
  }
}))
```

### ✅ 3. 处理异步操作

```javascript
it('应该处理异步操作', async () => {
  wrapper = mount(Component)
  
  // 触发异步操作
  await wrapper.find('button').trigger('click')
  
  // 等待 Vue 更新
  await wrapper.vm.$nextTick()
  
  // 验证结果
  expect(wrapper.vm.loading).toBe(false)
})
```

## 测试策略调整

### 简单测试优先

**❌ 避免:**
```javascript
// 过于复杂，依赖太多
it('应该渲染整个应用', () => {
  mount(App) // 需要 mock 所有依赖
})
```

**✅ 推荐:**
```javascript
// 简单直接，只测试组件本身
it('应该渲染组件', () => {
  mount(Login) // 只 mock Login 需要的依赖
})
```

### 隔离测试

**❌ 避免:**
```javascript
// 同时测试太多东西
it('应该处理登录、路由、store、i18n', () => {
  // 过于复杂
})
```

**✅ 推荐:**
```javascript
// 分别测试
it('应该渲染表单', () => { })
it('应该提交表单', () => { })
it('应该显示错误', () => { })
```

## 常见错误和解决方案

### 错误 1: "Cannot read property 'element' of undefined"

**原因:** 元素找不到

**解决:**
```javascript
// ❌ 错误
const element = wrapper.find('#nonexistent').element

// ✅ 正确
const element = wrapper.find('#existing')
if (element.exists()) {
  const el = element.element
}
```

### 错误 2: "Timed out after 5000ms"

**原因:** 异步操作未完成

**解决:**
```javascript
// ✅ 增加超时时间
it('应该处理异步操作', async () => {
  // 测试代码
}, { timeout: 10000 })
```

### 错误 3: "Cannot find module"

**原因:** Mock 路径错误

**解决:**
```javascript
// ✅ 使用正确的路径
vi.mock('../src/utils/stores/index.js', () => ({
  useStore: () => ({})
}))
```

## 调试技巧

### 1. 打印 HTML

```javascript
it('应该调试渲染', () => {
  wrapper = mount(Component)
  
  // 打印完整的 HTML
  console.log(wrapper.html())
  
  // 打印组件实例
  console.log(wrapper.vm)
})
```

### 2. 逐步验证

```javascript
it('应该逐步调试', () => {
  wrapper = mount(Component)
  
  // 步骤 1: 验证挂载
  console.log('挂载:', wrapper.exists())
  
  // 步骤 2: 验证元素
  console.log('元素:', wrapper.find('#test').exists())
  
  // 步骤 3: 验证状态
  console.log('状态:', wrapper.vm.someState)
})
```

### 3. 使用 Vue Devtools

```javascript
// 在测试中访问组件实例
const vm = wrapper.vm

// 可以直接调试
debugger // 在浏览器中使用
console.log(vm.$props)
console.log(vm.$data)
```

## 优化后的测试示例

### App.vue 测试（修复后）

```javascript
import { describe, it, expect, beforeEach, vi } from 'vitest'
import { mount } from '@vue/test-utils'
import { createPinia } from 'pinia'
import { createRouter, createWebHistory } from 'vue-router'
import { createI18n } from 'vue-i18n'
import ElementPlus from 'element-plus'
import App from '../src/App.vue'

// Mock Store
const mockStore = {
  initUserInfo: vi.fn()
}

vi.mock('../src/utils/stores', () => ({
  useStore: () => mockStore
}))

describe('App.vue', () => {
  let wrapper

  beforeEach(() => {
    const pinia = createPinia()
    const router = createRouter({
      history: createWebHistory(),
      routes: [{ path: '/', component: { template: '<div>Home</div>' } }]
    })
    const i18n = createI18n({
      legacy: false,
      locale: 'zh-hans',
      messages: {
        'zh-hans': { system: { name: 'Test' } }
      }
    })

    wrapper = mount(App, {
      global: {
        plugins: [pinia, router, i18n, ElementPlus],
        stubs: {
          'router-view': true,
          'el-config-provider': true
        }
      }
    })
  })

  it('应该正常渲染', async () => {
    await wrapper.vm.$nextTick()
    expect(wrapper.exists()).toBe(true)
  })

  it('应该初始化用户信息', async () => {
    await wrapper.vm.$nextTick()
    expect(mockStore.initUserInfo).toHaveBeenCalled()
  })
})
```

## 运行测试

```bash
# 基本运行
npm run test

# 观察模式
npm run test -- --watch

# 只运行一个文件
npm run test -- tests/App.test.js

# 详细的输出
npm run test -- --reporter=verbose
```

## 总结

测试失败的主要原因：
1. ⚠️ router-view 需要 stub
2. ⚠️ localStorage 需要配置
3. ⚠️ Store 需要 Mock
4. ⚠️ 异步操作需要等待

解决策略：
1. ✅ 使用 stubs 简化组件
2. ✅ Mock 所有外部依赖
3. ✅ 正确处理异步操作
4. ✅ 逐步测试，避免过于复杂
