# æµ‹è¯•æ‰§è¡Œæµç¨‹å›¾è§£

## ğŸ“Š å®Œæ•´æµ‹è¯•æµç¨‹å›¾

### 1. æµ‹è¯•åˆå§‹åŒ–æµç¨‹

```
å¼€å§‹æµ‹è¯•
    â†“
åŠ è½½æµ‹è¯•æ–‡ä»¶
    â†“
æ‰§è¡Œ setup.js
  â”œâ”€ è®¾ç½® jsdom ç¯å¢ƒ
  â”œâ”€ é…ç½® localStorage Mock
  â”œâ”€ é…ç½® matchMedia Mock
  â””â”€ æ¸…ç† DOM
    â†“
åˆ›å»ºæµ‹è¯•ç¯å¢ƒ
  â”œâ”€ åˆ›å»º Pinia Store
  â”œâ”€ åˆ›å»º Vue I18n
  â”œâ”€ åˆ›å»º Element Plus
  â””â”€ åˆ›å»º Vue Router (å¯é€‰)
    â†“
Ready to Test!
```

### 2. ç»„ä»¶æ¸²æŸ“æµç¨‹

```
mount(Login)
    â†“
åˆ›å»º Vue åº”ç”¨å®ä¾‹
    â†“
åˆå§‹åŒ–æ’ä»¶
  â”œâ”€ æ³¨å†Œ Pinia
  â”œâ”€ æ³¨å†Œ i18n
  â””â”€ æ³¨å†Œ Element Plus
    â†“
ç¼–è¯‘ Vue ç»„ä»¶
  â”œâ”€ è§£æ <template>
  â”œâ”€ å¤„ç† <script setup>
  â””â”€ ç¼–è¯‘ <style>
    â†“
åˆ›å»ºè™šæ‹Ÿ DOM (VNode)
    â†“
æ¸²æŸ“åˆ°çœŸå® DOM (é€šè¿‡ jsdom)
    â†“
ç»„ä»¶æŒ‚è½½å®Œæˆ âœ…
  â†“
wrapper.find('#email') ç°åœ¨å¯ä»¥å·¥ä½œäº†ï¼
```

### 3. ç”¨æˆ·è¾“å…¥æ¨¡æ‹Ÿæµç¨‹

```
test: ç”¨æˆ·è¾“å…¥é‚®ç®±
    â†“
emailInput.setValue('test@example.com')
    â†“
è§¦å‘ input äº‹ä»¶
    â†“
v-model æ•è·äº‹ä»¶
    â†“
æ›´æ–° form.email
    â†“
Vue å“åº”å¼ç³»ç»Ÿæ£€æµ‹å˜åŒ–
    â†“
æ›´æ–°ç»„ä»¶çš„å“åº”å¼çŠ¶æ€
    â†“
è‡ªåŠ¨æ›´æ–° DOM (å¦‚æœéœ€è¦)
    â†“
éªŒè¯ç»“æœ
    â†“
âœ… expect(wrapper.vm.form.email).toBe('test@example.com')
```

### 4. è¡¨å•æäº¤æµç¨‹

```
ç”¨æˆ·ç‚¹å‡»ç™»å½•æŒ‰é’®
    â†“
trigger('click')
    â†“
æ‰§è¡Œ @submit.prevent
    â†“
è°ƒç”¨ handleSubmit()
    â†“
æ‰§è¡ŒéªŒè¯é€»è¾‘
  â”œâ”€ æ£€æŸ¥é‚®ç®±æ ¼å¼
  â”œâ”€ æ£€æŸ¥å¯†ç é•¿åº¦
  â””â”€ æ£€æŸ¥å¯†ç åŒ¹é…ï¼ˆæ³¨å†Œæ¨¡å¼ï¼‰
    â†“
å¦‚æœéªŒè¯é€šè¿‡
    â†“
è®¾ç½® loading = true
    â†“
è°ƒç”¨ store.login(form)
    â†“
âš ï¸ è¿™é‡Œè¢« Mock æ‹¦æˆª
    â†“
mockStore.login() è¢«è°ƒç”¨
    â†“
è¿”å›æ¨¡æ‹Ÿæ•°æ®
    â†“
catch æˆ– then æ‰§è¡Œ
    â†“
è®¾ç½® loading = false
    â†“
æ›´æ–°ç»„ä»¶çŠ¶æ€
    â†“
âœ… æµ‹è¯•éªŒè¯ç»“æœ
```

## ğŸ” è¯¦ç»†æŠ€æœ¯åŸç†

### 1. DOM æŸ¥æ‰¾åŸç†

```javascript
wrapper.find('#email')
    â†“
Vue Test Utils æŸ¥è¯¢
    â†“
éå†ç»„ä»¶è™šæ‹Ÿ DOM
    â†“
æ‰¾åˆ°åŒ¹é…çš„å…ƒç´ 
    â†“
è½¬æ¢ä¸ºçœŸå® DOM èŠ‚ç‚¹
    â†“
è¿”å›åŒ…è£…åçš„å…ƒç´ 
    â†“
å¯ä»¥è°ƒç”¨ .setValue(), .trigger() ç­‰æ–¹æ³•
```

### 2. äº‹ä»¶è§¦å‘åŸç†

```javascript
element.trigger('click')
    â†“
åˆ›å»º Event å¯¹è±¡
    â†“
new MouseEvent('click')
    â†“
dispatchEvent(event)
    â†“
è§¦å‘äº‹ä»¶å¤„ç†å™¨
    â†“
æ‰§è¡Œ @click ç»‘å®šæ–¹æ³•
    â†“
æ›´æ–°ç»„ä»¶çŠ¶æ€
    â†“
ç­‰å¾… nextTick
    â†“
éªŒè¯ç»“æœ
```

### 3. Mock API åŸç†

```javascript
// 1. å®šä¹‰ Mock
vi.mock('../utils/api', () => ({
  auth: {
    login: vi.fn(() => Promise.resolve({}))
  }
}))

// 2. ç»„ä»¶è°ƒç”¨
await store.login(form)
    â†“
// 3. æ¨¡å—åŠ è½½è¢«æ‹¦æˆª
import { auth } from '../utils/api'
    â†“
// 4. è¿”å› Mock ç‰ˆæœ¬
auth.login  // è¿™æ˜¯ Mock å‡½æ•°
    â†“
// 5. æ‰§è¡Œ Mock é€»è¾‘
mockAuth.login()  // ä¸å‘é€çœŸå®è¯·æ±‚
    â†“
// 6. è¿”å›æ¨¡æ‹Ÿæ•°æ®
return Promise.resolve({ data: {...} })
```

## ğŸ“ˆ æµ‹è¯•æ‰§è¡Œæ—¶åºå›¾

```
æµ‹è¯•ä»£ç           DOMæ“ä½œ          Vueç»„ä»¶          Mock API
    |              |                 |                |
    | mount()      |                 |                |
    |--------------|---------------->|                |
    |              |                 |                |
    |              | åˆ›å»ºçœŸå®DOM     |                |
    |<-------------|----------------|                |
    |              |                 |                |
    | find('#email')                 |                |
    |--------------|---------------->|                |
    |              | è¿”å›å…ƒç´         |                |
    |<-------------|----------------|                |
    |              |                 |                |
    | setValue()   |                 |                |
    |--------------|---------------->|                |
    |              | è§¦å‘inputäº‹ä»¶   |                |
    |              |---------------->|                |
    |              |                 | æ›´æ–°form.email
    |              |                 |                |
    | éªŒè¯çŠ¶æ€      |                 |                |
    |--------------|---------------->|                |
    |              |                 |                |
    | trigger('click')               |                |
    |--------------|---------------->|                |
    |              | è§¦å‘clickäº‹ä»¶    |                |
    |              |---------------->|                |
    |              |                 | è°ƒç”¨handleSubmit
    |              |                 |                |
    |              |                 | è°ƒç”¨store.login
    |              |                 |-------------->|
    |              |                 |   Mockæ‰§è¡Œ    |
    |              |                 |<--------------|
    |              |                 |                |
    | éªŒè¯ç»“æœ      |                 |                |
    |<-------------|-----------------|                |
```

## ğŸ¬ å®é™…æµ‹è¯•æ‰§è¡Œç¤ºä¾‹

### ç¤ºä¾‹ï¼šå®Œæ•´çš„ç™»å½•æµç¨‹æµ‹è¯•

```javascript
describe('ç”¨æˆ·ç™»å½•æµç¨‹', () => {
  let wrapper
  
  beforeEach(() => {
    // ========== æ­¥éª¤ 1: åˆå§‹åŒ– ==========
    // åˆ›å»º Pinia, i18n, Element Plus
    pinia = createPinia()
    i18n = createTestI18n()
    
    // ========== æ­¥éª¤ 2: æ¸²æŸ“ç»„ä»¶ ==========
    wrapper = mount(Login, {
      global: {
        plugins: [pinia, i18n, ElementPlus]
      }
    })
    
    // æ­¤æ—¶çœŸå®çš„ DOM å·²ç»åˆ›å»ºï¼š
    // <div class="login-container">
    //   <input id="email" />
    //   <input id="password" />
    //   <button class="login-button">ç™»å½•</button>
    // </div>
  })
  
  it('åº”è¯¥å®Œæˆç™»å½•', async () => {
    // ========== æ­¥éª¤ 3: æŸ¥æ‰¾å…ƒç´  ==========
    const emailInput = wrapper.find('#email')
    const passwordInput = wrapper.find('#password')
    const loginButton = wrapper.find('.login-button')
    
    // è¿™äº›æ˜¯çœŸå®çš„ DOM å…ƒç´ ï¼
    
    // ========== æ­¥éª¤ 4: è¾“å…¥é‚®ç®± ==========
    await emailInput.setValue('user@example.com')
    
    // å‘ç”Ÿäº†ä»€ä¹ˆï¼š
    // 1. æ‰¾åˆ° <input id="email"> å…ƒç´ 
    // 2. è®¾ç½® element.value = 'user@example.com'
    // 3. è§¦å‘ input äº‹ä»¶
    // 4. v-model æ•è·äº‹ä»¶
    // 5. æ›´æ–° wrapper.vm.form.email = 'user@example.com'
    
    // âœ… éªŒè¯çœŸå®æ›´æ–°
    expect(wrapper.vm.form.email).toBe('user@example.com')
    expect(emailInput.element.value).toBe('user@example.com')
    
    // ========== æ­¥éª¤ 5: è¾“å…¥å¯†ç  ==========
    await passwordInput.setValue('password123')
    
    // åŒæ ·çš„è¿‡ç¨‹
    expect(wrapper.vm.form.password).toBe('password123')
    
    // ========== æ­¥éª¤ 6: ç‚¹å‡»ç™»å½• ==========
    await loginButton.trigger('click')
    
    // å‘ç”Ÿäº†ä»€ä¹ˆï¼š
    // 1. åˆ›å»º MouseEvent('click')
    // 2. è§¦å‘ @submit.prevent="handleSubmit"
    // 3. æ‰§è¡Œ handleSubmit() æ–¹æ³•
    // 4. è°ƒç”¨ store.login({ email, password })
    // 5. Mock å‡½æ•°è¢«è°ƒç”¨
    // 6. è¿”å›æ¨¡æ‹Ÿæ•°æ®
    // 7. æ›´æ–° loading çŠ¶æ€
    
    // ========== æ­¥éª¤ 7: éªŒè¯ç»“æœ ==========
    expect(mockStore.login).toHaveBeenCalledWith({
      email: 'user@example.com',
      password: 'password123'
    })
    expect(wrapper.vm.loading).toBe(false)
  })
})
```

## ğŸ”¬ æµ‹è¯•æ‰§è¡Œæ­¥éª¤è¯¦è§£

### æ­¥éª¤ 1: ç»„ä»¶æŒ‚è½½

```javascript
const wrapper = mount(Login)

// æ‰§è¡Œè¿‡ç¨‹ï¼š
// 1. Vue Test Utils åˆ›å»ºå®¹å™¨
const container = document.createElement('div')

// 2. åˆ›å»º Vue åº”ç”¨
const app = createApp(Login)

// 3. ä½¿ç”¨æ’ä»¶
app.use(pinia)
app.use(i18n)
app.use(ElementPlus)

// 4. æŒ‚è½½åˆ°å®¹å™¨
app.mount(container)

// 5. jsdom è§£æä¸ºçœŸå® DOM
// ç»“æœï¼šå†…å­˜ä¸­æœ‰çœŸå®çš„ DOM æ ‘
```

### æ­¥éª¤ 2: æŸ¥æ‰¾å…ƒç´ 

```javascript
const emailInput = wrapper.find('#email')

// æ‰§è¡Œè¿‡ç¨‹ï¼š
// 1. éå†è™šæ‹Ÿ DOM æ ‘
// 2. æ‰¾åˆ° id="email" çš„å…ƒç´ 
// 3. è½¬æ¢ä¸ºçœŸå® DOM èŠ‚ç‚¹
// 4. è¿”å›åŒ…è£…åçš„å¯¹è±¡

// è¿”å›çš„ emailInput æœ‰æ–¹æ³•ï¼š
emailInput.setValue()  // è®¾ç½®å€¼
emailInput.trigger()   // è§¦å‘äº‹ä»¶
emailInput.exists()    // æ£€æŸ¥å­˜åœ¨
emailInput.element     // çœŸå® DOM å…ƒç´ 
```

### æ­¥éª¤ 3: è§¦å‘äº‹ä»¶

```javascript
await emailInput.setValue('test@example.com')

// æ‰§è¡Œè¿‡ç¨‹ï¼š
// 1. emailInput.element.value = 'test@example.com'
// 2. åˆ›å»º Event('input')
// 3. element.dispatchEvent(event)
// 4. Vue çš„ v-model ç›‘å¬å™¨æ•è·
// 5. æ›´æ–° form.email
// 6. è§¦å‘ Vue å“åº”å¼æ›´æ–°
// 7. await ç¡®ä¿å®Œæˆ

// ç»“æœï¼šform.email === 'test@example.com' âœ…
```

### æ­¥éª¤ 4: API è°ƒç”¨

```javascript
await wrapper.vm.handleSubmit()

// æ‰§è¡Œè¿‡ç¨‹ï¼ˆLogin.vue ä¸­ï¼‰ï¼š
// 1. loading.value = true
// 2. è°ƒç”¨ await store.login(form)
//    â†“
// 3. å®é™…è°ƒç”¨ mockStore.login()
//    â†“
// 4. Mock å‡½æ•°è¿”å› Promise.resolve()
//    â†“
// 5. ç»§ç»­æ‰§è¡Œ
//    â†“
// 6. loading.value = false

// ç»“æœï¼šAPI è¢«æ­£ç¡®è°ƒç”¨ï¼ˆè™½ç„¶æ˜¯ Mockï¼‰âœ…
```

## ğŸ¯ å…³é”®è¦ç‚¹æ€»ç»“

### 1. **DOM æ˜¯çœŸå®çš„**
- jsdom æä¾›çœŸå®çš„ DOM API
- å…ƒç´ ã€äº‹ä»¶ã€æ ·å¼éƒ½å·¥ä½œ
- åªæ˜¯æ²¡æœ‰å¯è§†åŒ–çš„æµè§ˆå™¨çª—å£

### 2. **Vue æ˜¯çœŸå®çš„**
- ä½¿ç”¨çœŸå®çš„ Vue æ¸²æŸ“å¼•æ“
- å“åº”å¼ç³»ç»Ÿå®Œå…¨å·¥ä½œ
- ç”Ÿå‘½å‘¨æœŸé’©å­æ­£å¸¸æ‰§è¡Œ

### 3. **äº‹ä»¶æ˜¯çœŸå®çš„**
- çœŸå®çš„äº‹ä»¶è§¦å‘
- çœŸå®çš„äº‹ä»¶å¤„ç†å™¨
- çœŸå®çš„å“åº”å¼æ›´æ–°

### 4. **é€»è¾‘æ˜¯çœŸå®çš„**
- ç»„ä»¶æ–¹æ³•çœŸå®æ‰§è¡Œ
- æ¡ä»¶åˆ¤æ–­çœŸå®æ‰§è¡Œ
- æ•°æ®æµçœŸå®ä¼ é€’

### 5. **åªæœ‰å¤–éƒ¨ä¾èµ–æ˜¯ Mock çš„**
- API è°ƒç”¨è¢« Mock
- è·¯ç”±è·³è½¬è¢« Mock
- å¤–éƒ¨æœåŠ¡è¢« Mock

## âœ… å¯ä¿¡åº¦è¯„ä¼°

**æµ‹è¯•çœŸå®ä½œç”¨åˆ°ç•Œé¢çš„è¯æ®ï¼š**

1. âœ… DOM èŠ‚ç‚¹çœŸå®å­˜åœ¨
2. âœ… å±æ€§å€¼çœŸå®æ›´æ–°
3. âœ… äº‹ä»¶çœŸå®è§¦å‘
4. âœ… çŠ¶æ€çœŸå®å˜åŒ–
5. âœ… Vue å“åº”å¼çœŸå®å·¥ä½œ
6. âœ… ç»„ä»¶é€»è¾‘çœŸå®æ‰§è¡Œ

**ç»“è®ºï¼šæµ‹è¯•åœ¨æŠ€æœ¯å’Œé€»è¾‘å±‚é¢æ˜¯çœŸå®å¯ä¿¡çš„ï¼** ğŸ¯

